# smart_redirector.py
import string
import random
import sqlite3
from flask import Flask, request, redirect, render_template

app = Flask(__name__)

# ---------------- DATABASE SETUP ----------------
def init_db():
    conn = sqlite3.connect('urls.db')
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS urls (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            slug TEXT UNIQUE NOT NULL,
            original_url TEXT NOT NULL
        )
    ''')
    conn.commit()
    conn.close()

init_db()

# ---------------- HELPER FUNCTIONS ----------------
def generate_slug(length=6):
    chars = string.ascii_letters + string.digits
    return ''.join(random.choice(chars) for _ in range(length))

def save_url(slug, original_url):
    conn = sqlite3.connect('urls.db')
    c = conn.cursor()
    c.execute("INSERT INTO urls (slug, original_url) VALUES (?, ?)", (slug, original_url))
    conn.commit()
    conn.close()

def get_original_url(slug):
    conn = sqlite3.connect('urls.db')
    c = conn.cursor()
    c.execute("SELECT original_url FROM urls WHERE slug = ?", (slug,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else None

# ---------------- ROUTES ----------------
@app.route('/', methods=['GET', 'POST'])
def home():
    if request.method == 'POST':
        original_url = request.form['url']
        slug = generate_slug()
        save_url(slug, original_url)
        short_url = request.host_url + slug
        return render_template('index.html', short_url=short_url)
    return render_template('index.html', short_url=None)

@app.route('/<slug>')
def redirect_to_url(slug):
    original_url = get_original_url(slug)
    if original_url:
        # ----- CUSTOM RULE -----
        if "google.com" in original_url:
            return redirect("https://www.youtube.com")
        # Default behavior
        return redirect(original_url)
    return "URL not found", 404

# ---------------- TEMPLATES ----------------
# Save this as templates/index.html
"""
<!DOCTYPE html>
<html>
<head>
    <title>Smart URL Redirector</title>
</head>
<body>
    <h1>Smart URL Redirector</h1>
    <form method="POST">
        <input type="url" name="url" placeholder="Enter long URL" required>
        <button type="submit">Shorten</button>
    </form>

    {% if short_url %}
        <p>Short URL: <a href="{{ short_url }}">{{ short_url }}</a></p>
    {% endif %}
</body>
</html>
"""

if __name__ == '__main__':
    app.run(debug=True)
